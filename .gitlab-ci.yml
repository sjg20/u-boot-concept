# SPDX-License-Identifier: GPL-2.0+

# Grab our configured image.  The source for this is found
# in the u-boot tree at tools/docker/Dockerfile
image: trini/u-boot-gitlab-ci-runner:jammy-20230126-17Feb2023

# We run some tests in different order, to catch some failures quicker.
stages:
  - hwlab

.hwlab_template: &hwlab_dfn
  tags: [ 'hwlab' ]
  stage: hwlab
  before_script:
    # Clone uboot-test-hooks
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"

  script:
    # Environment:
    #   SRC  - source tree
    #   ROOT - directory above that
    #   OUT  - output directory for builds
    - export SRC="$(pwd)"
    - ROOT="$(dirname ${SRC})"
    - export BUILDMAN="${SRC}/tools/buildman/buildman"
    - export OUT="${ROOT}/out"
    - export PATH=$PATH:~/bin
    - export PATH=/vid/software/devel/ubtest/u-boot-test-hooks/bin:${PATH};

    - if [ -n "${blobs_from}" ]; then
        cp -v ${blobs_from} ${blobs_to};
      fi

    # Do the build
    - ret=0;
      ${BUILDMAN} -o ${OUT} --board ${board} -k -W || ret=$?;
      if [[ $ret -ne 0 && $ret -ne 129 ]]; then
        ./tools/buildman/buildman -o ${OUT} -sdeP;
        exit $ret;
      fi;

    # Load it on the device
    - echo PATH $PATH
    - ${SRC}/test/py/test.py -B $board --id ${id}
        --build-dir ${OUT}/current/$board -k ${test_spec}

  after_script:
    - echo done

kevin test:
  variables:
    board: "chromebook_kevin"
    id: "sjg-kevin"
    blobs_from: "/vid/software/devel/rk3399/*.elf"
    blobs_to: "board/google/gru/"
    test_spec: "help"
  <<: *hwlab_dfn

bob test:
  variables:
    board: "chromebook_bob"
    id: "sjg-bob"
    blobs_from: "/vid/software/devel/rk3399/*.elf"
    blobs_to: "board/google/gru/"
    test_spec: "help"
  <<: *hwlab_dfn

jerry test:
  variables:
    board: "chromebook_jerry"
    id: "sjg-jerry"
    test_spec: "help"
  <<: *hwlab_dfn

coral test:
  variables:
    board: "chromebook_coral"
    id: "sjg-coral"
    blobs_from: "/vid/software/devel/coral/bin/*.bin"
    blobs_to: "board/google/chromebook_coral/"
    test_spec: "help"
  <<: *hwlab_dfn

link test:
  variables:
    board: "chromebook_link"
    id: "sjg-link"
    blobs_from: "/vid/software/devel/link/bin/*.bin"
    blobs_to: "board/google/chromebook_link/"
    test_spec: "help"
  <<: *hwlab_dfn

samus test:
  variables:
    board: "chromebook_samus"
    id: "sjg-samus"
    blobs_from: "/vid/software/devel/samus/bin/*.bin"
    blobs_to: "board/google/chromebook_samus/"
    test_spec: "help"
  <<: *hwlab_dfn

rpi3 test:
  variables:
    board: "rpi_3_32b"
    id: "sjg-rpi_3b"
    test_spec: "help"
  <<: *hwlab_dfn
